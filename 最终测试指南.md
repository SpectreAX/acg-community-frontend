# 🎉 最终测试指南

## ✅ 配置已完成

所有代码配置已完成，现在可以进行最终测试！

---

## 📋 配置清单

- [x] 后端VOD SDK集成
- [x] REST API `/api/video/play-auth/{videoId}`
- [x] 前端播放器集成
- [x] Aliplayer License配置（对象格式）
- [x] 错误处理和日志
- [x] Vite代理配置

---

## 🧪 最终测试步骤

### 步骤1: 配置阿里云RAM权限 ⚠️ 必需

在测试之前，**必须先配置RAM权限**，否则后端会返回403错误。

**操作步骤**：

1. 登录阿里云RAM控制台
   ```
   https://ram.console.aliyun.com/
   ```

2. 找到AccessKey对应的RAM用户
   - AccessKey ID: `LTAI5tDksRAZWTLoyiBVfJEq`

3. 添加权限策略（选择一种）：
   - **推荐**: `AliyunVODReadOnlyAccess` （只读权限，足够播放使用）
   - **或**: `AliyunVODFullAccess` （完全权限，如果后续需要上传等功能）
   
4. 保存并等待生效（通常立即生效）

---

### 步骤2: 启动后端服务

**终端1 - 后端**:
```bash
cd f:\Dev\Final\acgcommunity
mvn spring-boot:run
```

**等待启动成功**，看到类似日志：
```
Started AcgcommunityApplication in X.XXX seconds
```

**验证后端API**（在浏览器访问）:
```
http://localhost:9090/api/video/play-auth/e0555dd6d43d71f0803f5017f0f80102
```

**预期响应**（如果RAM权限已配置）：
```json
{
  "code": "200",
  "msg": "成功",
  "data": {
    "videoId": "e0555dd6d43d71f0803f5017f0f80102",
    "playAuth": "eyJTZWN1cml0eVRva2VuIjoiQ0FJUz...",
    "videoMeta": {
      "title": "...",
      "duration": 1431.444,
      "coverUrl": "https://...",
      "status": "Normal"
    }
  }
}
```

**如果返回403错误**：说明RAM权限还没配置好，返回步骤1。

---

### 步骤3: 启动前端服务

**终端2 - 前端**:
```bash
cd f:\Dev\Final\acg-community-web
npm run dev
```

**等待启动成功**，看到：
```
➜  Local:   http://localhost:5173/
```

---

### 步骤4: 浏览器测试

1. **打开浏览器**
   ```
   http://localhost:5173
   ```

2. **进入任意剧集详情页**
   - 例如：`http://localhost:5173/play/467495/2042993`

3. **打开开发者工具**（F12）

4. **检查Console日志**

   **✅ 成功的日志**：
   ```
   正在获取视频播放凭证... e0555dd6d43d71f0803f5017f0f80102
   成功获取播放凭证，初始化播放器...
   播放器创建成功
   ```

   **❌ 如果看到错误**：
   - `403 Forbidden.RAM` → RAM权限未配置
   - `404 Not Found` → 后端未启动
   - `License error` → License配置问题（应该已解决）

5. **验证视频播放**
   - 播放器应该显示在页面上
   - 视频可以正常播放
   - 封面图正确显示
   - 控制栏可以使用

6. **测试集数切换**
   - 点击侧边栏的其他集数
   - 播放器应该重新加载
   - Console显示：`切换集数，重新初始化播放器: xxx`

---

## 🔍 关键检查点

### Network标签检查

打开 Network 标签，刷新页面，查找 `play-auth` 请求：

**✅ 正常情况**：
- **Request URL**: `http://localhost:5173/api/video/play-auth/e0555dd6d43d71f0803f5017f0f80102`
- **Status Code**: `200`
- **Response**: 包含 `playAuth` 字段的JSON

**❌ 异常情况及解决**：
- **404**: 后端未启动 → 启动后端
- **403**: RAM权限错误 → 配置RAM权限
- **500**: 后端代码错误 → 检查后端日志

---

## 📝 License域名注意事项

当前License配置：
```javascript
license: {
  domain: "spectreax.com",
  key: "xP9VKwtoMk14sJcPO37e2a619e3454c32846cf8f1b0ae3c08"
}
```

### 可能的问题

如果License绑定的是 `spectreax.com`，但你在 `localhost:5173` 访问，**可能**会有License验证问题。

**解决方案**（如果遇到）：

**方案1**: 修改hosts文件（推荐开发环境）
```
# Windows: C:\Windows\System32\drivers\etc\hosts
# 添加一行
127.0.0.1 spectreax.com
```

然后访问：`http://spectreax.com:5173`

**方案2**: 重新申请License
- 申请一个绑定 `localhost` 的开发License
- 用于本地开发

**方案3**: 忽略（如果不影响）
- 某些情况下，阿里播放器在开发环境可能不严格验证域名
- 先测试，如果能正常播放就无需修改

---

## 🎯 完整验收清单

测试时请逐项确认：

**后端**：
- [ ] 后端服务正常启动（9090端口）
- [ ] 直接访问API返回200
- [ ] 响应包含 `playAuth` 字段
- [ ] 无403 RAM权限错误

**前端**：
- [ ] 前端服务正常启动（5173端口）
- [ ] 剧集详情页能正常访问
- [ ] Network中看到 `play-auth` 请求
- [ ] 请求状态码为200

**播放器**：
- [ ] 播放器容器正常显示
- [ ] 视频可以播放
- [ ] 封面图正确显示
- [ ] 控制栏功能正常
- [ ] 切换集数时播放器重新加载
- [ ] 无License警告

**Console**：
- [ ] 无红色错误
- [ ] 看到"播放器创建成功"日志
- [ ] 无License相关警告

---

## 🐛 常见问题快速排查

### 问题1: 403 Forbidden.RAM

**原因**: RAM权限未配置

**解决**: 
1. 登录 https://ram.console.aliyun.com/
2. 为RAM用户添加 `AliyunVODReadOnlyAccess` 权限
3. 刷新页面重试

### 问题2: 播放器不显示

**检查**:
1. Console是否有错误？
2. Network中 `play-auth` 请求是否成功？
3. 后端是否返回了 `playAuth`？

**解决**: 根据具体错误信息对症下药

### 问题3: License警告

**如果仍有警告**: "must be configured with a license"

**检查**:
1. License是否是对象格式？（不是字符串）
2. domain和key字段是否都有？
3. 是否与申请时的域名一致？

---

## 🎉 测试成功的标志

当你看到以下情况，说明集成成功：

1. ✅ 页面加载后，播放器自动显示
2. ✅ 视频自动播放（或点击播放按钮后能播放）
3. ✅ Console无红色错误
4. ✅ 切换集数时，播放器重新加载

**恭喜！阿里云VOD SDK集成完成！** 🎊

---

## 📞 如遇问题

如果测试过程中遇到任何问题，请提供：

1. **浏览器Console截图**（完整错误信息）
2. **Network标签截图**（显示 `play-auth` 请求详情）
3. **后端日志**（最后20行）

我会帮你进一步诊断！
